<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="board">
<!-- ================== 전체 게시글 조회 ================== -->
<select id="selectBoardList" resultMap="boardExtMap">
<!-- 첨부파일이 있는지도 처리 -->
	select
		b.*,
		(select count(*) from attachment where board_no = b.no) attach_count
	from
		board b
	order by
		no desc
</select>
<resultMap type="boardExt" id="boardExtMap">
	<!-- 숫자 -> 자동으로 boolean 형변환해줌 -->
	<result column="attach_count" property="hasAttachment"/>
</resultMap>
<!-- ================== 전체 게시글 수 조회 ================== -->
<select id="selectBoardTotalContents" resultType="_int">
	select
		count(*)
	from
		board
</select>
<!-- ================== 게시글 추가 ================== -->
<insert id="insertBoard">
	insert into
		board(
			no,
			title,
			member_id,
			content
		)
	values (
		seq_board_no.nextval,
		#{title},
		#{memberId},
		#{content}
	)
	<!-- 
		insertBooard에서 발급받은 no를 가져와야 함
		insert태그 안에 selectKey태그로 예비로 하나 더 실행할 수 있는 쿼리 작성 가능
	 -->
	 <!--
	 	keyProperty - 발급받은 board pk no값을
	 			이번 insert태그에 전달된 parameter board객체의 
	 			no property(필드)에 저장한다
	 	resultType - 어떤 타입이 리턴될지,
	 	order : after - insert태그를 실행 후에 가져온다 -->
	 <selectKey keyProperty="no" resultType="_int" order="AFTER">
	 	select
	 		seq_board_no.currval
	 	from
	 		dual
	 </selectKey>
</insert>
<!-- ================== 첨부파일 추가 ================== -->
<insert id="insertAttachment">
	insert into
		attachment(
			no,
			board_no,
			original_filename,
			renamed_filename
		)
	values(
		seq_attachment_no.nextval,
		#{boardNo},
		#{originalFilename},
		#{renamedFilename}		
	)
</insert>
</mapper>